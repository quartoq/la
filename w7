Создание дистрибутива со всеми версиями windows 7

Microsoft не предоставляет для загрузки установочный образ windows 7, который содержал бы в себе все редакции (ultimate, enterprise, professional, home premium, home basic, starter) разной разрядности (x32 и x64), но можно сделать этот образ самостоятельно, используя средства Windows AIK (все необходимые для этого операции также можнопроделать в виртуальной машине с windows>=7).

Windows AIK (WAIK, Windows Automated Installation Kit - пакет автоматической установки Windows) - это набор инструментов (средств) и документации, разработанный Microsoft для поддержки настройки и развёртывания операционных систем Windows.
Скачать offline установщик WAIK 3.0 можно по ссылке (данную ссылку можно найти в википедии):
http://www.microsoft.com/ru-ru/download/details.aspx?id=5753
Скачается KB3AIK_RU.iso размером 1.2ГБ, который нужно распаковать, например, при помощи 7-zip и установить, запустив установщик waikamd64.msi (для x64 windows) или waikx86.msi (для x32 windows).

Так как редакция windows 7 ultimate содержит в себе все другие редакции, то возьмём её для работы.
Скачиваем русскоязычные (другие нам не нужны в данном случае) дистрибутивы windows 7 ultimate разных разрядностей там где удобнее, главное, потом убедиться, что хеши этих образов совпадают с официальными, которые указаны на сайте msdn для подписчиков.
В итоге скачаны были файлы установочных образов с именами
ru_windows_7_ultimate_with_sp1_x64_dvd_u_677391.iso
ru_windows_7_ultimate_with_sp1_x86_dvd_u_677463.iso



http://rutracker.org/forum/viewtopic.php?t=4529698

Windows 7 Ultimate with Service Pack 1 (x64) - DVD (Russian)
File Name: ru_windows_7_ultimate_with_sp1_x64_dvd_u_677391.iso
SIZE: 3 229 378 560 byte
Date Published (UTC): 5/12/2011 2:46:24 PM
Last Updated (UTC): 5/12/2011 2:46:24 PM
SHA1: 106CAF0695318AD0D82E441A54BE8460BF099B09
MD5: 10963967C12E6B58D346054F51AFF5C1
ISO/CRC: AAA11D2E

Windows 7 Home Basic with Service Pack 1 (x86) - DVD (Russian)
File Name: ru_windows_7_home_basic_with_sp1_x86_dvd_u_676482.iso
SIZE: 2 471 983 104 byte
Date Published (UTC): 5/12/2011 2:32:49 PM
Last Updated (UTC): 5/12/2011 2:32:49 PM
SHA1: 7C7446200C478814CC983A04FA8431BFDBA95F19
MD5: 6E5DF8B47B35DDC6A42917BE3E0FA410
ISO/CRC: 0DD7F832


Для работы нам понадобяться 7-zip, ultraiso и утилиты из windows aik (утилита imagex точно понадобиться), хотя всё можно проделать при помощи ultraiso и imagex.


В конечном итоге, соберём установочный дистрибутив, который содержит в себе 32- и 64-разрядные версии windows 7 professional (легко активируется kms-активаторами в отличие от ultimate), для чего можно поступить, например, так:

- открываем, например, при помощи 7-zip или ultraiso дистрибутив ru_windows_7_ultimate_with_sp1_x64_dvd_u_677391.iso и извлекаем оттуда файл sources\install.wim, после чего переименовываем его в install_x64.wim.

- открываем, например, при помощи 7-zip или ultraiso дистрибутив ru_windows_7_ultimate_with_sp1_x86_dvd_u_677463.iso и извлекаем оттуда файл sources\install.wim, после чего переименовываем его в install_x32.wim.

Переименования двух извлечённых из установочных дистрибутивов файлов install.wim нужны для того, чтобы разместить эти оба файла в одном каталоге (так как в одном каталоге не может быть двух файлов с одинаковыми именами) и чтобы различить эти файлы.
Позже данные из этих двух файлов объединятся в файле install.wim, который будет запакован обратно в ru_windows_7_ultimate_with_sp1_x86_dvd_u_677463.iso (о том почему именно в него, будет пояснено ниже).


- запускаем cmd от имени администратора (dism не отработает в командной строке без повышенных привилегий), заходим в каталог с install.wim-ами и смотрим информацию о содрежащихся в них редакциях windows командами
dism /get-wiminfo /wimfile:install_x64.wim
dism /get-wiminfo /wimfile:install_x32.wim

Видим, что в дистрибутиве x64 редакция professional имеет индекс 3, в дистрибутиве x32 - индекс 4 (в дистрибутиве x64 нет редакции starter, поэтому индекс ниже получается).


Но лучше сразу открыть командную строку средств развёртывания, там в path по умолчанию находится путь
C:\Program Files\Windows AIK\Tools\PETools\
в котором размещаются нужные нам утилиты (imagex, например).

- соберём нужные нам данные в файл install.wim при помощи утилиты imagex (это утилита из набора windows aik)
imagex /export install_x64.wim 3 install.wim "Windows 7 Professional (x64)"
imagex /export install_x32.wim 4 install.wim "Windows 7 Professional (x86)"

В этих двух строчка утилита imagex с ключом /export экспортирует из указанных файлов (install_x64.wim и install_x32.wim соответственно) нужные индекс и помещает данные из него в файл install.wim, а также присваивает новым индексам описание (оно указывается в команде в самом конце).
Формат команды imagex:
imagex /export файл_источника номер_источника имя_источника файл_назначения имя_назначения
При указании путей можно и при наличии пробелов необходимо заключать части команды в кавычки.

В конце проверим, что содержится в нашем файле install.wim командой
dism /get-wiminfo /wimfile:install.wim



- поместим наш новосозданный install.wim в дистрибутив ru_windows_7_ultimate_with_sp1_x86_dvd_u_677463.iso
Именно в дистрибутив x32, так как он отличается от аналогичного x64 разрядного файлом boot.wim (предустановочная среда windows), а 32-разряная предустановочноя среда может загружаться на машинах любой разрядности, тогда как 64-разрядная предустановочная среда может загружаться только на машинах с 64-разрядными процессорами.
Здесь мы зальём install.wim при помощи ultraiso: открыть образ, удалить install.wim и ei.cfg (ei.cfg удаляем, чтобы была возможность выбора редакции при установке с этого образа, в нашем случае это не понадобиться, так как всего одну редакцию professional делаем), заменить его нашим, сохранить как образ, дав ему другое имя.
Также можно было это сделать консольной командой oscdimg из набора windows aik


При загрузке с новоиспечённого дистрибутива будет появляться окно с вариантами выбором редакции для установки.
